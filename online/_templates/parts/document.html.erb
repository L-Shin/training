<div class="row" style="padding-left: 0; padding-right: 0;">
    <div class="row">
        <div class="medium-12 columns">
        <h1><%=(attr :doctitle) %></h1>
        </div>
    </div>
    <!--div class="row">
        <div class="large-3 columns">
            <a href="/graphacademy/online-training/getting-started-graph-databases-neo4j-part-1/">Part 1: Introduction</a>
        </div>
        <div class="large-3 columns">
            <a href="/graphacademy/online-training/getting-started-graph-databases-neo4j-part-2/">Part 2: Creating and Querying Graphs</a>
        </div>
        <div class="large-3 columns">
            <a href="/graphacademy/online-training/getting-started-graph-databases-neo4j-part-3/">Part 3: Filters and Paths</a>
        </div>
        <div class="large-3 columns">
            <a href="/graphacademy/online-training/getting-started-graph-databases-neo4j-part-4/">Part 4: Indexing, Recommendations, Import</a>
        </div>
    </div-->
    <div class="large-9 large-push-3 columns guide-section-content">
       <div id="content">
        <%= content %>
       </div>
    </div>
    <div class="large-3 large-pull-9 columns"><!--was: sticky-->
        <!--div><a href="/graphacademy"><image src="http://dev.assets.neo4j.com.s3.amazonaws.com/wp-content/uploads/neo4j_logo-325x150.png"></a></div-->
        <% if (attr? :toc)  %>
        <div id="toc" class="<%= attr 'toc-class', 'toc' %>">
        <div id="toctitle"><%= attr 'toc-title' %></div>
        <%= converter.convert self, 'outline' %>
        </div><% end %>
        <div>
	      <h4>Progress</h4>
	      <ul class="quiz-progress fa-ul">
		    <li><i id="quiz1-progress"></i>Section 1</li>
		    <li><i id="quiz2-progress"></i>Section 2</li>
		    <li><i id="quiz3-progress"></i>Section 3</li>
		    <li><i id="quiz4-progress"></i>Section 4</li>
	      <ul>	 
	      </ul>
	    </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script>
<script src="https://cdn.auth0.com/js/lock/10.20.0/lock.min.js"></script>    
<script src="https://cdn.auth0.com/js/auth0/8.10.1/auth0.min.js"></script>     
<script src="//js.maxmind.com/js/apis/geoip2/v2.1/geoip2.js" type="text/javascript"></script>


<script type="text/javascript">
    var options = {
      theme: {
        logo: 'https://s3.amazonaws.com/dev.assets.neo4j.com/wp-content/uploads/neo4j_logo_globe.png',
        primaryColor: '#58b535'
      },
      initialScreen: (localStorage.getItem('previousLogin') == null)?'signUp':'login',
      languageDictionary: {
        title: 'Neo4j',
        signin: {
          title: 'Sign in'
        },
        signup: {
          title: 'Sign up'
        }
      },
      auth: {
        redirectUrl: 'https://neo4j.com/graphacademy/login/?return=' + window.location.href,
        params: {
          scope: 'openid name email',
          responseType: 'token'
        }
      }
    }

var lock = new Auth0Lock(
  'xSEhNfb0vyfF5SnlzGKx5F6LhAB9pabu',
  'neo4j-sync.auth0.com',
  options
);
var webAuth = new auth0.WebAuth({
      domain: 'neo4j-sync.auth0.com',
      clientID: 'xSEhNfb0vyfF5SnlzGKx5F6LhAB9pabu'
    });

</script>


<script type="text/javascript">
var quizesStatus = {};
$(".quiz-progress").find("li").css("cssText", "list-style-image: none !important");
$(".quiz-progress").find("li i").addClass("fa");
$(".quiz-progress").find("li i").addClass("fa-li");
$(".quiz-progress").find("li i").addClass("fa-circle-thin");


$('.next-section').click(function(event) {
  var quizSuccess = gradeQuiz($(".quiz").first()); // gradeQuiz($( this ).closest(".quiz"));
  var hrefSuccess = event.target.href;
  event.preventDefault();
  updateResponse = updateQuizStatus();
  postQuizStatus(updateResponse['passed'], updateResponse['failed']).then(
    function() { 
      if (quizSuccess) {
        document.location = hrefSuccess;
      }
    }
  );
});

function gradeQuiz(theQuiz) {
// $( ".quiz" ).each(function() {
  var quizName = theQuiz.attr("id");
  var quizSuccess = true;

  if ( quizName in quizesStatus && quizesStatus[quizName] ) {
    return true;
  } 

  theQuiz.find("h3").css("color", "#525865");
  
  theQuiz.find(".required-answer").each(function() {
    if (! $( this ).prev(":checkbox").prop("checked")  ) {
      $( this ).closest(".ulist").prev("h3").css("color", "red");
      quizSuccess = false;
    }
  });
  theQuiz.find(".false-answer").each(function() {
    if ( $( this ).prev(":checkbox").prop("checked")  ) {
      $( this ).closest(".ulist").prev("h3").css("color", "red");
      quizSuccess = false;
    }
  });
  quizesStatus[ quizName ] = quizSuccess;
  return quizSuccess;
};

function postQuizStatus(passed, failed) {
  id_token = Cookies.get("graphacademy_id_token");
  return $.ajax
  ({
    type: "POST",
    url: "https://gdybeyd4sa.execute-api.us-east-1.amazonaws.com/dev/setQuizStatus",
    contentType: "application/json",
    dataType: 'json',
    async: true,
    data: JSON.stringify(
      { "className": "online-training-1",
        "passed": passed,
        "failed": failed
      }),
    headers: {
      "Authorization": id_token
    }
  });
}

function getQuizStatusRemote() {
  id_token = Cookies.get("graphacademy_id_token");
  return $.ajax
  ({
    type: "GET",
    url: "https://gdybeyd4sa.execute-api.us-east-1.amazonaws.com/dev/getQuizStatus?className=online-training-1",
    contentType: "application/json",
    dataType: 'json',
    async: true,
    headers: {
      "Authorization": id_token
    }
  });
}

function updateQuizStatus() {
  passedArray = []
  failedArray = []
  for (quizName in quizesStatus) {
    $("#" + quizName + "-progress").removeClass("fa-circle-thin");
    $("#" + quizName + "-progress").removeClass("fa-close");
    $("#" + quizName + "-progress").removeClass("fa-check");

    if (quizesStatus[quizName]) {
      passedArray.push(quizName);
      $("#" + quizName + "-progress").css("color", "green");
      $("#" + quizName + "-progress").addClass("fa-check");
    } else {
      failedArray.push(quizName);
      $("#" + quizName + "-progress").css("color", "red");
      $("#" + quizName + "-progress").addClass("fa-close");
    }
  }
  return { "passed": passedArray, "failed": failedArray };
}

  webAuth.renewAuth({
        redirectUri: 'https://neo4j.com/graphacademy/auth-iframe/',
        usePostMessage: true,
        postMessageDataType: 'graphacademy-auth',
        scope: 'openid name email',
        nonce: btoa(Math.floor((Math.random() * 100000000)) + ":" + Math.round(Date.now() / 10))
      }, function (error, renewAuthResult) {
        if (renewAuthResult) {
          Cookies.set('graphacademy_id_token', renewAuthResult['idToken'], { path: '/graphacademy/' });
          console.log('renewAuth successful', error, renewAuthResult);
          getQuizStatusRemote().then( function( value ) { 
            failed = value['quizStatus']['failed'];
            passed = value['quizStatus']['passed'];
            for (i in failed) {
              quizesStatus[ failed[i] ] = false;
            }
            for (i in passed) {
              quizesStatus[ passed[i] ] = true;
            }
            updateQuizStatus();
            currentQuizStatus = quizesStatus[ $(".quiz").attr("id") ];
            if (currentQuizStatus) {
              $(".quiz").hide();
            }
          } );
        } else {
          lock.show();
        }
  });

</script>
